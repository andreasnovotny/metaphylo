---
title: "Analysing Plankton Diet Metabarcoding Data"
author: "Andreas Novotny"
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
# Loading packages required for this vingette
library(dada2)
library(phyloseq)
library(DESeq2)
library(tidyverse)
library(metaphylo)
```

# 1. Opening data and construct a phyloseq object

```{r}
#Loading data from this package, to be used in the vingette
data("metadata_16S")
data("seqtab_16S")
data("tax_16S")
```

Use help documentation to se more information about data and functions:

```{r}
?metadata_16S
?filterTaxonomy
```


### 1.1 Modify the taxonomy output from dada2

The *filterTaxonomy* function deleats all the taxonomic information with high uncertenty,
below a sertain thershold for the bootstrap value, and replaces it with Na.

To avoid Na`s in the dataset, that carris no information, the *completeTaxonomy* function fills the empty gaps with information from the higher taxonomic levels.

```{r}
tax_16S <- filterTaxonomy(tax_16S, minboot = 75)
tax_16S <- completeTaxonomy(tax_16S, string = "_x")
```




### 1.2 Build a phyloseq object

The function *dada2ToPhyloseq* takes the specific output from the dada2 pipeline as input to create a phyloseq object.
Tax glom is a phyloseq function that collapses sequence variants with the same taxonomic affiliation, in this case at species level (highest taxonomic resolution). 

*This operation might take up to 5 minutes*.

```{r}
ps_16S <- dada2ToPhyloseq(seqtab_16S, tax_16S, metadata_16S) #%>% 
#  tax_glom(taxrank = "Species")
```

### 1.3 Create a CSV table from the phyloseq object, to open in excel.

```{r}
#phyloseqToCSV(ps_16S, header="ID_friendly", filename="~/Desktop/RSV_16S.csv")
```
```{r include=FALSE}
data(ps_16S)
```


```{r include=FALSE}
# Accessors of the 18S PS object:
sample_names(ps_16S) # Formal names of samples
sample_variables(ps_16S) # Metadata variables
rank_names(ps_16S) # Taxonomic levels

get_variable(ps_16S, "SORTED_type") # Access any metadata variable
#get_taxa() # Abundance values for one OTU
#get_sample() # Abundance value for one sample
```


# 2. Analysing the phyloseq object with DEseq2

### 2.1 Get table of significant fold change expressions

```{r}
dds_table <- ps_16S %>% 
  subset_samples(MONTH == "aug") %>%
  subset_samples(SORTED_type == "Rotifer") %>% 
  deseqTable(~ SORTED_genus)
```

### 2.2 Select relevant prey organisms and make boxplot

*relevantSpecies*
*abundancePlot*

```{r}

plot <- ps_16S %>% 
  subset_samples(SORTED_genus == "Synchaeta") %>% 
  relevantSpecies(method = "vst", cutoff = 0.75, design = ~ ID_friendly) %>% 
  abundancePlot(x = "Species", fill = "Genus")
plot

```


### 2.3 Create heat map of significant and relevant fold change expressions


*getSignificant*

```{r}
# Potentially publishable graph!!!!

relevant_otu <- ps_16S %>% 
  subset_samples(SORTED_genus=="Synchaeta") %>%
  subset_samples(MONTH!="may") %>% 
  relevantSpecies(method = "vst", cutoff=0.3, design = ~ID_friendly) %>%
  taxa_names()
plot <- ps_16S %>%
  subset_samples(SORTED_genus=="Synchaeta") %>%
  subset_samples(MONTH!="may") %>%
  prune_taxa(relevant_otu, .) %>% 
  getSignificant(design = ~MONTH, alpha = 0.01, number = 50, vst = TRUE) %>%
  plot_heatmap(taxa.order = "Phylum",
               taxa.label = "Genus",
               sample.label = "ID_friendly", 
               sample.order = "SORTED_genus")
plot
  
```





```{r}
sessionInfo()
```
